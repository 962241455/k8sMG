Started by user admin
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] echo
flask-demo.yangmv.com
[Pipeline] echo
5000
[Pipeline] echo
release
[Pipeline] node
Still waiting to schedule task
‘Jenkins’ doesn’t have label ‘haimaxy-jnlp’
Agent jnlp-g4hx7 is provisioned from template Kubernetes Pod Template
Agent specification [Kubernetes Pod Template] (haimaxy-jnlp): 
* [jnlp] harbor-k8s.shinezone.com/ops/jenkins:jnlp

Running on jnlp-g4hx7 in /home/jenkins/workspace/flask-demo
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Clone)
[Pipeline] echo
1.Clone 代码
[Pipeline] git
Cloning the remote Git repository
Cloning repository https://github.com/yangmv/flask-demo.git
 > git init /home/jenkins/workspace/flask-demo # timeout=10
Fetching upstream changes from https://github.com/yangmv/flask-demo.git
 > git --version # timeout=10
 > git fetch --tags --progress https://github.com/yangmv/flask-demo.git +refs/heads/*:refs/remotes/origin/*
 > git config remote.origin.url https://github.com/yangmv/flask-demo.git # timeout=10
 > git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git config remote.origin.url https://github.com/yangmv/flask-demo.git # timeout=10
Fetching upstream changes from https://github.com/yangmv/flask-demo.git
 > git fetch --tags --progress https://github.com/yangmv/flask-demo.git +refs/heads/*:refs/remotes/origin/*
 > git rev-parse refs/remotes/origin/master^{commit} # timeout=10
 > git rev-parse refs/remotes/origin/origin/master^{commit} # timeout=10
Checking out Revision 2b60c355587dbb1f4165bc19491f2ee99e9af6ec (refs/remotes/origin/master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 2b60c355587dbb1f4165bc19491f2ee99e9af6ec
 > git branch -a -v --no-abbrev # timeout=10
 > git checkout -b master 2b60c355587dbb1f4165bc19491f2ee99e9af6ec
Commit message: "edit"
 > git rev-list --no-walk 2b60c355587dbb1f4165bc19491f2ee99e9af6ec # timeout=10
[Pipeline] script
[Pipeline] {
[Pipeline] sh
[flask-demo] Running shell script
+ git rev-parse --short HEAD
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Test)
[Pipeline] echo
2.代码测试[PAAS]
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Build)
[Pipeline] echo
3.构建打包 Docker 镜像
[Pipeline] sh
[flask-demo] Running shell script
+ docker build -t harbor-k8s.shinezone.com/ops/flask-demo:2b60c35 .
Sending build context to Docker daemon  76.29kB
Step 1/5 : From python:3.6-alpine
 ---> a3184dc36856
Step 2/5 : ADD . /data1/www
 ---> 25d1027e1d1c
Step 3/5 : WORKDIR /data1/www
 ---> Running in 13c12aa7818e
Removing intermediate container 13c12aa7818e
 ---> 9dc65fadcfe2
Step 4/5 : RUN pip install flask
 ---> Running in f671f88fbfd4
Collecting flask
  Downloading https://files.pythonhosted.org/packages/7f/e7/08578774ed4536d3242b14dacb4696386634607af824ea997202cd0edb4b/Flask-1.0.2-py2.py3-none-any.whl (91kB)
Collecting Werkzeug>=0.14 (from flask)
  Downloading https://files.pythonhosted.org/packages/20/c4/12e3e56473e52375aa29c4764e70d1b8f3efa6682bef8d0aae04fe335243/Werkzeug-0.14.1-py2.py3-none-any.whl (322kB)
Collecting itsdangerous>=0.24 (from flask)
  Downloading https://files.pythonhosted.org/packages/76/ae/44b03b253d6fade317f32c24d100b3b35c2239807046a4c953c7b89fa49e/itsdangerous-1.1.0-py2.py3-none-any.whl
Collecting Jinja2>=2.10 (from flask)
  Downloading https://files.pythonhosted.org/packages/7f/ff/ae64bacdfc95f27a016a7bed8e8686763ba4d277a78ca76f32659220a731/Jinja2-2.10-py2.py3-none-any.whl (126kB)
Collecting click>=5.1 (from flask)
  Downloading https://files.pythonhosted.org/packages/fa/37/45185cb5abbc30d7257104c434fe0b07e5a195a6847506c074527aa599ec/Click-7.0-py2.py3-none-any.whl (81kB)
Collecting MarkupSafe>=0.23 (from Jinja2>=2.10->flask)
  Downloading https://files.pythonhosted.org/packages/ac/7e/1b4c2e05809a4414ebce0892fe1e32c14ace86ca7d50c70f00979ca9b3a3/MarkupSafe-1.1.0.tar.gz
Building wheels for collected packages: MarkupSafe
  Running setup.py bdist_wheel for MarkupSafe: started
  Running setup.py bdist_wheel for MarkupSafe: finished with status 'done'
  Stored in directory: /root/.cache/pip/wheels/81/23/64/51895ea52825dc116a55f37043f49be0939bcf603de54e5cde
Successfully built MarkupSafe
Installing collected packages: Werkzeug, itsdangerous, MarkupSafe, Jinja2, click, flask
Successfully installed Jinja2-2.10 MarkupSafe-1.1.0 Werkzeug-0.14.1 click-7.0 flask-1.0.2 itsdangerous-1.1.0
Removing intermediate container f671f88fbfd4
 ---> 10ce34916348
Step 5/5 : CMD ["python","app.py"]
 ---> Running in 4c0bf032f40b
Removing intermediate container 4c0bf032f40b
 ---> 3f2a6e14e2db
Successfully built 3f2a6e14e2db
Successfully tagged harbor-k8s.shinezone.com/ops/flask-demo:2b60c35
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Push)
[Pipeline] echo
4.推送 Docker 镜像到仓库
[Pipeline] withCredentials
[Pipeline] {
[Pipeline] sh
[flask-demo] Running shell script
+ docker login -u **** -p **** https://harbor-k8s.shinezone.com
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
Login Succeeded
[Pipeline] sh
[flask-demo] Running shell script
+ docker push harbor-k8s.shinezone.com/ops/flask-demo:2b60c35
The push refers to repository [harbor-k8s.shinezone.com/ops/flask-demo]
f9b0b7bb8a37: Preparing
80d0c0fa8763: Preparing
4a2596f9aa79: Preparing
5cf3066ccdbc: Preparing
76a1661c28fc: Preparing
beefb6beb20f: Preparing
df64d3292fd6: Preparing
beefb6beb20f: Waiting
df64d3292fd6: Waiting
4a2596f9aa79: Layer already exists
5cf3066ccdbc: Layer already exists
76a1661c28fc: Layer already exists
beefb6beb20f: Layer already exists
df64d3292fd6: Layer already exists
80d0c0fa8763: Pushed
f9b0b7bb8a37: Pushed
2b60c35: digest: sha256:bb79630f3b95d3b7acacba317e4dc7e289a71bb2accbd24e0d453e2b53080b7d size: 1788
[Pipeline] }
[Pipeline] // withCredentials
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (YAML)
[Pipeline] echo
5.YAML配置
[Pipeline] sh
[flask-demo] Running shell script
+ sed -i s/<BUILD_TAG>/2b60c35/ flask-demo-deploy.yaml
[Pipeline] sh
[flask-demo] Running shell script
+ sed -i s/<PORT>/5000/ flask-demo-deploy.yaml
[Pipeline] sh
[flask-demo] Running shell script
+ sed -i s/<PORT>/5000/ flask-demo-ingress.yaml
[Pipeline] sh
[flask-demo] Running shell script
+ sed -i s/<DOMAIN>/flask-demo.yangmv.com/ flask-demo-ingress.yaml
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy)
[Pipeline] echo
6.开始部署
[Pipeline] sh
[flask-demo] Running shell script
+ kubectl apply -f flask-demo-deploy.yaml -n release
deployment "flask-demo" created
service "flask-demo" created
[Pipeline] sh
[flask-demo] Running shell script
+ kubectl apply -f flask-demo-ingress.yaml -n release
ingress "flask-demo-ingress" created
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
